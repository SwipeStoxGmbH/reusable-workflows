name: 'Deploy using kubectl and kustomize'
description: 'In-cluster deployment'

inputs:
  namespace:
    description: 'Namespace for the service to be deployed at'
    required: true
  overlay:
    description: 'path to kustomiize overlay'
    required: true

  

runs:
  using: "composite"
  steps:
    - name: install kops and export kubeconfig
      shell: bash
      run: |
          echo "Setting up KUBECTL"
          curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl
          echo "Installing Kustomize"
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"  | bash
          chmod +x ./kustomize
          sudo mv ./kustomize /usr/local/bin/
          echo "Deploying"
          cd ${{ inputs.overlay }} && kustomize build . | kubectl apply -n ${{ inputs.namespace }} -f -
